(window.webpackJsonp=window.webpackJsonp||[]).push([[250],{596:function(t,s,v){"use strict";v.r(s);var e=v(42),a=Object(e.a)({},(function(){var t=this,s=t.$createElement,v=t._self._c||s;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h1",{attrs:{id:"kubernetes-准备数据卷"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-准备数据卷"}},[t._v("#")]),t._v(" Kubernetes 准备数据卷")]),t._v(" "),v("h2",{attrs:{id:"概述"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[t._v("#")]),t._v(" 概述")]),t._v(" "),v("p",[t._v("在 Docker 中就有数据卷的概念，当容器删除时，数据也一起会被删除，想要持久化使用数据，需要把主机上的目录挂载到 Docker 中去，在 K8S 中，数据卷是通过 Pod 实现持久化的，如果 Pod 删除，数据卷也会一起删除，k8s 的数据卷是 docker 数据卷的扩展，K8S 适配各种存储系统，包括本地存储 EmptyDir，HostPath， 网络存储（NFS，GlusterFS，PV/PVC）等。")]),t._v(" "),v("p",[t._v("我们以部署 MySQL8 为例，采用 NFS + PV/PVC 网络存储方案实现我们的 Kubernetes 数据持久化。")]),t._v(" "),v("h2",{attrs:{id:"什么是-nfs"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#什么是-nfs"}},[t._v("#")]),t._v(" 什么是 NFS")]),t._v(" "),v("p",[t._v("NFS 是 Network File System 的简写，即网络文件系统，NFS 是 FreeBSD 支持的文件系统中的一种。NFS 基于 RPC (Remote Procedure Call) 远程过程调用实现，其允许一个系统在网络上与它人共享目录和文件。通过使用 NFS，用户和程序就可以像访问本地文件一样访问远端系统上的文件。NFS 是一个非常稳定的，可移植的网络文件系统。具备可扩展和高性能等特性，达到了企业级应用质量标准。由于网络速度的增加和延迟的降低，NFS 系统一直是通过网络提供文件系统服务的有竞争力的选择 。")]),t._v(" "),v("h2",{attrs:{id:"nfs-原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#nfs-原理"}},[t._v("#")]),t._v(" NFS 原理")]),t._v(" "),v("p",[t._v("NFS 使用 RPC (Remote Procedure Call) 的机制进行实现，RPC 使得客户端可以调用服务端的函数。同时，由于有 VFS 的存在，客户端可以像使用其它普通文件系统一样使用 NFS 文件系统。经由操作系统的内核，将 NFS 文件系统的调用请求通过 TCP/IP 发送至服务端的 NFS 服务。NFS 服务器执行相关的操作，并将操作结果返回给客户端。")]),t._v(" "),v("div",{attrs:{align:"center"}},[v("img",{attrs:{src:"http://ww1.sinaimg.cn/large/007Rnr4nly1g8mwwi3n8jj30jg0asmxv.jpg"}})]),t._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[t._v("NFS 服务主要进程")]),t._v(" "),v("ul",[v("li",[t._v("rpc.nfsd：最主要的 NFS 进程，管理客户端是否可登录")]),t._v(" "),v("li",[t._v("rpc.mountd：挂载和卸载 NFS 文件系统，包括权限管理")]),t._v(" "),v("li",[t._v("rpc.lockd：非必要，管理文件锁，避免同时写出错")]),t._v(" "),v("li",[t._v("rpc.statd：非必要，检查文件一致性，可修复文件")])])]),t._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[t._v("NFS 的关键工具")]),t._v(" "),v("ul",[v("li",[t._v("主要配置文件：/etc/exports")]),t._v(" "),v("li",[t._v("NFS 文件系统维护命令：/usr/bin/exportfs")]),t._v(" "),v("li",[t._v("共享资源的日志文件： /var/lib/nfs/*tab")]),t._v(" "),v("li",[t._v("客户端查询共享资源命令： /usr/sbin/showmount")]),t._v(" "),v("li",[t._v("端口配置： /etc/sysconfig/nfs")])])]),t._v(" "),v("h2",{attrs:{id:"nfs-服务端配置"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#nfs-服务端配置"}},[t._v("#")]),t._v(" NFS 服务端配置")]),t._v(" "),v("p",[t._v("在 NFS 服务器端的主要配置文件为 /etc/exports 时，通过此配置文件可以设置共享文件目录。每条配置记录由 NFS 共享目录、NFS 客户端地址和参数这 3 部分组成，格式如下：")]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("[NFS 共享目录] [NFS 客户端地址 1 (参数 1, 参数 2, 参数 3……)] [客户端地址 2 (参数 1, 参数 2, 参数 3……)]\n")])])]),v("ul",[v("li",[t._v("NFS 共享目录：服务器上共享出去的文件目录")]),t._v(" "),v("li",[t._v("NFS 客户端地址：允许其访问的 NFS 服务器的客户端地址，可以是客户端 IP 地址，也可以是一个网段 (192.168.141.0/24)")]),t._v(" "),v("li",[t._v("访问参数：括号中逗号分隔项，主要是一些权限选项")])]),t._v(" "),v("h3",{attrs:{id:"访问权限参数"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#访问权限参数"}},[t._v("#")]),t._v(" 访问权限参数")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("序号")]),t._v(" "),v("th",[t._v("选项")]),t._v(" "),v("th",[t._v("描述")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("1")]),t._v(" "),v("td",[t._v("ro")]),t._v(" "),v("td",[t._v("客户端对于共享文件目录为只读权限。默认")])]),t._v(" "),v("tr",[v("td",[t._v("2")]),t._v(" "),v("td",[t._v("rw")]),t._v(" "),v("td",[t._v("客户端对于共享文件目录具有读写权限")])])])]),t._v(" "),v("h3",{attrs:{id:"用户映射参数"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#用户映射参数"}},[t._v("#")]),t._v(" 用户映射参数")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("序号")]),t._v(" "),v("th",[t._v("选项")]),t._v(" "),v("th",[t._v("描述")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("1")]),t._v(" "),v("td",[t._v("root_squash")]),t._v(" "),v("td",[t._v("使客户端使用 root 账户访冋时，服务器映射为服务器本地的匿名账号")])]),t._v(" "),v("tr",[v("td",[t._v("2")]),t._v(" "),v("td",[t._v("no_root_squash")]),t._v(" "),v("td",[t._v("客户端连接服务端时如果使用的是 root，那么也拥有对服务端分享的目录的 root 权限")])]),t._v(" "),v("tr",[v("td",[t._v("3")]),t._v(" "),v("td",[t._v("all_squash")]),t._v(" "),v("td",[t._v("将所有客户端用户请求映射到匿名用户或用户组（nfsnobody)")])]),t._v(" "),v("tr",[v("td",[t._v("4")]),t._v(" "),v("td",[t._v("no_all_squash")]),t._v(" "),v("td",[t._v("与上相反。默认")])]),t._v(" "),v("tr",[v("td",[t._v("5")]),t._v(" "),v("td",[t._v("anonuid=xxx")]),t._v(" "),v("td",[t._v("将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户(UID=xxx)")])]),t._v(" "),v("tr",[v("td",[t._v("6")]),t._v(" "),v("td",[t._v("anongid=xxx")]),t._v(" "),v("td",[t._v("将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户(GUI=xxx)")])])])]),t._v(" "),v("h3",{attrs:{id:"其它配置参数"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#其它配置参数"}},[t._v("#")]),t._v(" 其它配置参数")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("序号")]),t._v(" "),v("th",[t._v("选项")]),t._v(" "),v("th",[t._v("描述")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("1")]),t._v(" "),v("td",[t._v("sync")]),t._v(" "),v("td",[t._v("同步写操作，数据写入存储设备后返回成功信息。默认")])]),t._v(" "),v("tr",[v("td",[t._v("2")]),t._v(" "),v("td",[t._v("async")]),t._v(" "),v("td",[t._v("异步写提作，数据在未完全写入存储设备前就返回成功信息，实际还在内存，")])]),t._v(" "),v("tr",[v("td",[t._v("3")]),t._v(" "),v("td",[t._v("wdelay")]),t._v(" "),v("td",[t._v("延迟写入选项，将多个写提请求合并后写入硬盘，减少 I/O 次数， NFS 非正常关闭数据可能丢失。默认")])]),t._v(" "),v("tr",[v("td",[t._v("4")]),t._v(" "),v("td",[t._v("no_wdelay")]),t._v(" "),v("td",[t._v("与上相反，不与 async 同时生效，如果 NFS 服务器主要收到小且不相关的请求，该选项实际会降低性能")])]),t._v(" "),v("tr",[v("td",[t._v("5")]),t._v(" "),v("td",[t._v("subtree")]),t._v(" "),v("td",[t._v("若输出目录是一个子目录，则 NFS 服务器将检查其父目录的权限。默认")])]),t._v(" "),v("tr",[v("td",[t._v("6")]),t._v(" "),v("td",[t._v("no_subtree")]),t._v(" "),v("td",[t._v("即使输出目录是一个子目录， NFS 服务器也不检查其父目录的权限，这样可以提高效率")])]),t._v(" "),v("tr",[v("td",[t._v("7")]),t._v(" "),v("td",[t._v("secure")]),t._v(" "),v("td",[t._v("限制客户端只能从小于 1024 的 TCP/IP 端口连接 NFS 服务器。默认")])]),t._v(" "),v("tr",[v("td",[t._v("8")]),t._v(" "),v("td",[t._v("insecure")]),t._v(" "),v("td",[t._v("允许客户端从大于 1024 的 TCP/IP 端口连接服务器")])])])]),t._v(" "),v("h2",{attrs:{id:"安装-nfs-服务端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#安装-nfs-服务端"}},[t._v("#")]),t._v(" 安装 NFS 服务端")]),t._v(" "),v("p",[t._v("由于 NFS 是一套分布式文件系统，我们再创建一台独立的虚拟机作为我们 NFS 服务端，配置如下")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("主机名")]),t._v(" "),v("th",[t._v("IP")]),t._v(" "),v("th",[t._v("系统")]),t._v(" "),v("th",[t._v("CPU/内存")]),t._v(" "),v("th",[t._v("磁盘")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("kubernetes-volumes")]),t._v(" "),v("td",[t._v("192.168.141.130")]),t._v(" "),v("td",[t._v("Ubuntu Server 18.04")]),t._v(" "),v("td",[t._v("2 核 2G")]),t._v(" "),v("td",[t._v("20G")])])])]),t._v(" "),v("ul",[v("li",[t._v("创建一个目录作为共享文件目录")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("mkdir -p /usr/local/kubernetes/volumes\n")])])]),v("ul",[v("li",[t._v("给目录增加读写权限")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("chmod a+rw /usr/local/kubernetes/volumes\n")])])]),v("ul",[v("li",[t._v("安装 NFS 服务端")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("apt-get update\napt-get install -y nfs-kernel-server\n")])])]),v("ul",[v("li",[t._v("配置 NFS 服务目录，打开文件 vi /etc/exports，在尾部新增一行，内容如下\n"),v("ul",[v("li",[t._v("/usr/local/kubernetes/volumes： 作为服务目录向客户端开放")]),t._v(" "),v("li",[t._v("*：表示任何 IP 都可以访问")]),t._v(" "),v("li",[t._v("rw： 读写权限")]),t._v(" "),v("li",[t._v("sync： 同步权限")]),t._v(" "),v("li",[t._v("no_subtree_check： 表示如果输出目录是一个子目录，NFS 服务器不检查其父目录的权限")]),t._v(" "),v("li",[t._v("no_root_squash： 客户端连接服务端时如果使用的是 root，那么也拥有对服务端分享的目录的 root 权限")])])])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("/usr/local/kubernetes/volumes *(rw,sync,no_subtree_check,no_root_squash)\n")])])]),v("ul",[v("li",[t._v("重启服务，使配置生效")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("/etc/init.d/nfs-kernel-server restart\n")])])]),v("h2",{attrs:{id:"安装-nfs-客户端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#安装-nfs-客户端"}},[t._v("#")]),t._v(" 安装 NFS 客户端")]),t._v(" "),v("p",[t._v("安装客户端的目的是验证是否可以上传文件到服务端，安装命令如下")]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("apt-get install -y nfs-common\n")])])]),v("ul",[v("li",[t._v("创建 NFS 客户端挂载目录")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("mkdir -p /usr/local/kubernetes/volumes-mount\n")])])]),v("ul",[v("li",[t._v("将 NFS 服务器的 /usr/local/kubernetes/volumes 目录挂载到 NFS 客户端的 /usr/local/kubernetes/volumes-mount 目录")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("mount 192.168.141.130:/usr/local/kubernetes/volumes /usr/local/kubernetes/volumes-mount\n")])])]),v("ul",[v("li",[t._v("使用 df 命令查看挂载信息")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("df\n# 输出如下\nFilesystem                                    1K-blocks    Used Available Use% Mounted on\nudev                                             977544       0    977544   0% /dev\ntmpfs                                            201732    1232    200500   1% /run\n/dev/mapper/ubuntu--vg-ubuntu--lv              19475088 4780912  13681852  26% /\ntmpfs                                           1008648       0   1008648   0% /dev/shm\ntmpfs                                              5120       0      5120   0% /run/lock\ntmpfs                                           1008648       0   1008648   0% /sys/fs/cgroup\n/dev/loop0                                        90624   90624         0 100% /snap/core/7270\n/dev/loop1                                        93184   93184         0 100% /snap/core/6350\n/dev/sda2                                        999320   77944    852564   9% /boot\ntmpfs                                            201728       0    201728   0% /run/user/0\n# 有此输出表示挂载成功\n192.168.141.130:/usr/local/kubernetes/volumes  19475200 4780800  13681920  26% /usr/local/kubernetes/volumes-mount\n")])])]),v("h2",{attrs:{id:"验证-nfs-服务"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#验证-nfs-服务"}},[t._v("#")]),t._v(" 验证 NFS 服务")]),t._v(" "),v("ul",[v("li",[t._v("测试文件上传")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("ip addr > /usr/local/kubernetes/volumes-mount/test.txt\n")])])]),v("ul",[v("li",[t._v("查看 /usr/local/kubernetes/volumes 目录下是否有 test.txt 文件，有则表示成功")])]),t._v(" "),v("h2",{attrs:{id:"取消-nfs-客户端挂载"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#取消-nfs-客户端挂载"}},[t._v("#")]),t._v(" 取消 NFS 客户端挂载")]),t._v(" "),v("blockquote",[v("p",[t._v("注意： 不要直接在挂载目录下执行，否则会报错")])]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("umount /usr/local/kubernetes/volumes-mount\n")])])])])}),[],!1,null,null,null);s.default=a.exports}}]);